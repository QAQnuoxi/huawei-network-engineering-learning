
# IPv4概述
- IPv4 (Internet Protocol Version 4)协议族是TCP/IP协议族中最为核心的协议族
- IPv4工作在TCP/IP协议栈的网络层，该层与OSI参考模型的网络层相对应。
- [[网络层]]提供了无连接数据传输服务，即网络在发送数据报文时不需要先建立连接，每一个IP数据报文独立发送。
- 在本章节中，将
	- 介绍IPv4地址的基本概念
	- 介绍如何进行子网划分
	- 介绍网络IP地址规划
	- 介绍IP地址的基本配置。
- 需掌握
	- 描述网络层的主要协议
	- 描述IPv4地址的概念、分类及特殊IP地址
	- 计算IP网络以及IP子网
	- 掌握IP网络地址规划方式

## IPv4报文格式
![[Pasted image 20221020165955.png]]

## IPv4地址

概要：
- [[#IPv4地址的表示方法]]
- [[#IPv4地址的构成]]
- [[#IP地址寻址]]
- [[#IPv4地址的分类（有类编址）]]
- [[#IPv4地址的类型]]

### IPv4地址的表示方法
- 一个IPv4地址有32 bit。
- IPv4地址通常采用“点分十进制”表示。
- IPv4地址范围: 
	- 十进制：0.0.0.0~255.255.255.255。
	- 二进制：00000000.00000000.00000000.00000000~11111111.11111111.11111111.11111111
- ![[Pasted image 20221020173531.png]]

### IPv4地址的构成
| | |
|--|--|
|网络部分|用来标识一个网络|
|主机部分|用来区分一个网络内的不同主机。|
|网络掩码|区分一个IP地址中的网络部分及主机部分。|
- ![[Pasted image 20221020174422.png]]
- ![[Pasted image 20221020174438.png]]

-  IPv4地址由如下两部分组成：
	-  网络部分 (网络号)：用来标识一个网络。
		-  IP地址不能反映任何有关主机位置的地理信息，只能通过网络号码字段判断出主机属于哪个网络。
		-  对于网络号相同的设备，无论实际所处的物理位置如何，它们都是处在同一个网络中。
	- 主机部分 (主机号)：用来区分一个网络内的不同主机。
- 网络掩码 (Netmask)，又称子网掩码 (Subnet Mask):
	- 网络掩码为32 bit，与IP地址的位数一样，通常也以点分十进制数来表示。
	- 网络掩码不是一个IP地址，在二进制的表示上是一堆连续的1、后面接一堆连续的0。
	- 通常将网络掩码中1的个数称为这个网络掩码的长度。如：掩码0.0.0.0的长度是0，掩码252.0.0.0的长度是6。
	- 网络掩码一般与IP地址结合使用，其中值为1的比特对应IP地址中的网络位；值为0的比特对应IP地址中的主机位，以此来辅助我们识别一个IP地址中的网络位与主机位。即网络掩码中1的个数就是IP地址的网络号的位数，0的个数就是IP地址的主机号的位数。


### IP地址寻址

- 网络号用于表示主机所在的网络，类似于“XX省XX市XX区XX小区”的作用。
- 主机号用于表示网络号所定义的网络范围内某个特定的主机接口，类似于门牌号“XX栋XX号”的作用。
- 网络寻址：
	- 二层网络寻址：可直接通过IP地址，找到对应的主机接口。
	- 三层网络寻址：利用网关转发来自不同网段之间的数据包。
- 网关：
	- 报文转发过程中，首先需要确定转发路径以及通往目的网段的接口。如果目的主机与源主机不在同一网段，报文需要先转发到网关，然后通过网关将报文转发到目的网段。
	- 网关是指接收并处理本地网段主机发送的报文并转发到目的网段的设备。为实现此功能，网关必须知道目的网段的IP地址。网关设备上连接本地网段的接口地址即为该网段的网关地址。
- ![[Pasted image 20221020174756.png]]

### IPv4地址的分类（有类编址）
- 为了方便IP地址的管理及组网，IP地址分成五类：
	-  A、B、C、D、E类的类别字段分别是二进制数0、10、110、1110、1111，通过网络号码字段的前几个比特就可以判断IP地址属于哪一类，这是区分各类地址最简单的方法。
	-  A、B、C三类地址是单播IP地址 (除一些特殊地址外)，只有这三类地址才能分配给主机接口使用。
	- D类地址属于组播IP地址。
	- E类地址专门用于特殊的实验目的。
	- 本节内容，只关注A、B、C三类地址。
- A、B、C类地址比较：
	-  使用A类地址的网络称为A类网络；使用B类地址的网络称为B类网络；使用C类地址的网络称为C类网络。
	- A类网络的网络号为8 bit，个数很少，但所允许的主机接口的个数很多；首位恒定为0，地址空间为：0.0.0.0~127.255.255.255。
	- B类网络的网络号为16 bit，介于A类和C类网络之间；首两位恒定为10，地址空间为：128.0.0.0~191.255.255.255。
	- C类网络的网络号为24 bit，个数很多，但所允许的主机接口的个数就很少；首三位恒定为110，地址空间为：192.0.0.0~223.255.255.255。
- 注：
	- 主机 (Host)，通常指路由器和计算机的统称。并且常把主机的某个接口的IP地址简称为主机IP地址。
	- 组播地址：组播能实现一对多传递消息。
- ![[Pasted image 20221020175115.png]]



### IPv4地址的类型
- 网络地址
	- 用于标识一个网络
	- ![[Pasted image 20221020180118.png]]
	- 网络号为X，主机号的每个比特都为0。
	- 不能分配给具体的主机接口使用。

- 广播地址
	- 用于向该网络中的所有主机发送数据的特殊地址。
	- ![[Pasted image 20221020180306.png]]
	- 网络号为X，主机号的每个比特都为1。
	- 不能分配给具体的主机接口使用。
- 可用地址
	- 可分配给网络中的节点或网络设备接口的地址。
	- ![[Pasted image 20221020180314.png]]
	- 又称主机地址，可用分配给具体的主机接口使用。
----
注意：
- 网络地址和广州地址不能直接被节点或网络设备所使用。
- 一个网段可用地址数量为：$2^n-2$（n:  主机部分的比特位数）
	- 一个网段可用地址数量计算：
		- 一个网段的主机位为n位，则IP地址数为：2ⁿ，可用IP地址数为：2ⁿ-2 (减去网络地址和广播地址)。

----

#### 计算IP地址可用地址数（练习）

- 例：172.16.10.1/16这个B类地址的网络地址、广播地址以及可用地址数分别是？
- ![[Pasted image 20221020182222.png]]
---

- 网络地址：将网络地址的主机位全设为0，所得结果是该IP地址所在网络的网络地址。
-  广播地址：将网络地址的主机位全设为1，所得结果是该IP地址所在网络的广播地址。
- IP地址数：2ⁿ，n为主机位位数。
- 可用IP地址数：2ⁿ-2，n为主机位位数。
-----

答案：

- 网络地址：10.0.0.0/8
- 广播地址：10.255.255.255
- IP地址数：$2^{24}$
▫ 可用IP地址数：$2^{24}-2$
▫ 可用IP地址范围：10.0.0.1/8~10.255.255.254/8

### 私网IP地址
- 公网IP地址: IP地址是由IANA统一分配的，以保证任何一个IP地址在Internet上的唯一性。这里的IP地址是指公网IP地址。
- 私网IP地址: 实际上一些网络不需要连接到Internet，比如一个大学的封闭实验室内的网络，只要同一网络中的网络设备的IP地址不冲突即可。在IP地址空间里，A、B、C三类地址中各预留了一些地址专门用于上述情况，称为私网IP地址。
	- A类：10.0.0.0~10.255.255.255
	- B类: 172.10.0.0~172.31.255.255
	- C类：192.168.0.0~192.168.255.255

----

- 为了解决IP地址短缺的问题，提出了私有地址的概念。私有地址是指内部网络或主机地址，这些地址只能用于某个内部网络，不能用于公共网络。
	- 公网IP地址：连接到Internet的网络设备必须具有由ICANN分配的公网IP地址。
	- 私网IP地址：私网IP地址的使用使得网络可以得到更为自由地扩展，因为同一个私网IP地址是可以在不同的私有网络中重复使用的。
- 私有网络连接到Internet：私有网络由于使用了私网IP地址，是不允许连接到Internet的。后来在实际需求的驱动下，许多私有网络也希望能够连接到Internet上，从而实现私网与Internet之间的通信，以及通过Internet实现私网与私网之间的通信。私网与Internet的互联，必须使用网络地址转换 (NAT)技术实现。
- 注：
	- NAT (Network Address Translation)，网络地址转换，其基本作用是实现私网IP地址与公网IP地址之间的转换。
	- IANA (Internet Assigned Numbers Authority)，因特网地址分配组织。
![[Pasted image 20221020183040.png]]


### 特殊IP地址

- IP地址空间中，有一些特殊的IPIP地址，这些IP地址有特殊的含义和作用，举例如下。

|特殊IP地址|地址范围|作用|
|--------|--------|---------|
|有限广播地址|255.255.255.255|可作为目的地址，发往该网段所有主机（受限于网关）|
|任意地址|0.0.0.0|“任何网络”的网络地址;“这个网络上这个主机接口”的IP地址|
|环回地址|127.0.0.0/8|测试设备自身的软件系统|
|本地链路地址|169.254.0.0/24|当主机自动获取地址失败后，可使用该网段中的某个地址进行临时通信|


- 255.255.255
	- 这个地址称为有限广播地址，它可以作为一个IP报文的目的IP地址使用。
	- 路由器接收到目的IP地址为有限广播地址的IP报文后，会停止对该IP报文的转发。
- 0.0.0.0
	- 如果把这个地址作为网络地址，它的意思就是“任何网络”的网络地址；如果把这个地址作为主机接口地址，它的意思就是“这个网络上主机接口”的IP地址。
	- 例如：当一个主机接口在启动过程中尚未获得自己的IP地址时，就可以向网络发送目的IP地址为有限广播地址、源IP地址为0.0.0.0的DHCP请求报文，希望DHCP服务器在收到自己的请求后，能够给自己分配一个可用的IP地址。
- 127.0.0.0/8
	- 这个地址为环回地址，它可以作为一个IP报文的目的IP地址使用。其作用是测试设备自身的软件系统。
	- 一个设备产生的、目的IP地址为环回地址的IP报文是不可能离开这个设备本身的。
- 169.254.0.0/16
	- 如果一个网络设备获取IP地址的方式被设置成了自动获取方式，但是该设备在网络上又没有找到可用的DHCP服务器，那么该设备就会使用169.254.0.0/16网段的某个地址来进行临时通信。
- 注：DHCP (Dynamic Host Configuration Protocol)，动态主机配置协议，用于动态分网
络配置参数，如IP地址。

## IPv4 vs [[IPv6]]
- 由全球IP地址分配机构，IANA (Internet Assigned Numbers Authority)管理的IPv4地址，于2011年完全用尽。随着最后一个IPv4公网地址分配完毕，加上接入公网的用户及设备越来越多, IPv4地址枯竭的问题日益严重，这是当前IPv6替代IPv4的最大源动力。
--------
|版本|地址长度|地址分类|特点|
|------|-------|-------|----|
|IPv4|32 bit  |单播地址、广播地址、组播地址|地址枯竭、包头设计不合理、对ARP的依赖，导致广播泛滥|
|IPv6|128 bit  |单播地址、广播地址、任意地址|无限地址、简化的报文头部、IPv6地址自动部署|



# IPv4的基础配置命令

1. 进入接口视图
	1. `` [Huawei] interface interface-type interface-number ``
	2. 通过此命令可以进入指定的接口视图，配置接口的相关属性。
	- *interface-type interface-number*：指定接口类型和接口编号。接口类型和接口编号之间可以输入空格也可以不输入空格。
2. 配置接口的IP地址
	1. `` [Huawei-GigabitEthernet0/0/1] ip address ip-address { mask | mask-length} ``
	2. 在接口视图下，通过此命令来给网络设备上的接口配置IP地址，实现网的互连。
	- ip-address:指定接口的IP地址，点分十进制形式。
	- mask: 指定子网掩码，点分十进制形式。
	- mask-length: 指定掩码长度，整数形式，取值范围是0～32。

### 案例： 配置接口IP地址

![[Pasted image 20221021105820.png]]
- 在上述两台路由器互的网络中，配置设备的互联物理接口地址以及各自的逻辑地址。

1. 配置物理接口地址
```
[RTA] interface gigabitethermet 0/0/1
[RTA-GigabitEthernet0/0/1] ip address 192.168.1.1255.255.255.0
或
[RTA-GigabitEthernet0/0/1] ip address 192.168.1.124

```

2. 配置逻辑接口地址
```
[RTA] interface LoopBack o
[RTA-LoopBack0] ip address 1.1.1.1 255.255.255.255
或
[RTA-LoopBack0]ip address 1.1.1.1 32
```

- 物理接口：物理接口是指网络设备上实际存在的接口，分为负责承担业务传输的业务接口和负责管理设备的管理接口，例如GE业务接口和MEth管理接口。
- 逻辑接口：逻辑接口是指能够实现数据交换功能但物理上不存在、需要通过配置建立的接口，需要承担业务传输，例如VLANIF接口、Loopback接口。
- Loopback接口：用户需要一个接口状态永远是Up的接口的IP地址时，可以选择Loopback接口的IP地址。
- Loopback接口一旦被创建，其物理状态和链路协议状态永远是Up，即使该接口上没有配置IP地址。
- Loopback接口配置IP地址后，就可以对外发布。Loopback接口上可以配置32位掩码的IP地址，达到节省地址空间的目的。
- Loopback接口不能封装任何链路层协议，数据链路层也就不存在协商问题，其协议状态永远都是Up。
- 对于目的地址不是本地IP地址，出接口是本地Loopback接口的报文，设备会将其直接丢弃。

